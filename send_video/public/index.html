<!DOCTYPE html>
<html id="home" lang="en">

<head>
<title>Pre-recorded media streaming Â® Muaz Khan</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="author" type="text/html" href="https://plus.google.com/100325991024054712503">
<meta name="author" content="Muaz Khan">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<style>

html { background: #eee; }

body {
  font-family: "Inconsolata", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", monospace;
  font-size: 1.2em;
  line-height: 1.2em;
  margin: 0;
}

article, footer {
  display: block;
  max-width: 900px;
  min-width: 360px;
  width: 80%;
}

article {
  background: #fff;
  border: 1px solid;
  border-color: #ddd #aaa #aaa #ddd;
  margin: 2.5em auto 0 auto;
  padding: 2em;
}

h1 { margin-top: 0; }

article p:first-of-type { margin-top: 1.6em; }

article p:last-child { margin-bottom: 0; }

footer {
  margin: 0 auto 2em auto;
  text-align: center;
}

footer a {
  color: #666;
  font-size: inherit;
  padding: 1em;
  text-decoration: none;
  text-shadow: 0 1px 1px #fff;
}

footer a:hover, footer a:focus { color: #111; }

h1, h2 {
  border-bottom: 1px solid black;
  display: inline;
  font-weight: normal;
  line-height: 36px;
  padding: 0 0 3px 0;
}

a {
  color: #2844FA;
  text-decoration: none;
}

a:hover, a:focus { color: #1B29A4; }

a:active { color: #000; }

:-moz-any-link:focus {
  border: 0;
  color: #000;
}

::selection { background: #ccc; }

::-moz-selection { background: #ccc; }

button {
  -moz-border-radius: 3px;
  -moz-transition: none;
  -webkit-transition: none;
  background: #0370ea;
  background: -moz-linear-gradient(top, #008dfd 0, #0370ea 100%);
  background: -webkit-linear-gradient(top, #008dfd 0, #0370ea 100%);
  border: 1px solid #076bd2;
  border-radius: 3px;
  color: #fff;
  display: inline-block;
  font-family: inherit;
  font-size: .8em;
  line-height: 1.3;
  padding: 5px 12px;
  text-align: center;
  text-shadow: 1px 1px 1px #076bd2;
}

button:hover { background: rgb(9, 147, 240); }

button:active { background: rgb(10, 118, 190); }

button[disabled] {
  background: none;
  border: 1px solid rgb(187, 181, 181);
  color: gray;
  text-shadow: none;
}

strong {
  color: rgb(204, 14, 14);
  font-family: inherit;
  font-weight: normal;
}
</style>
<!-- for HTML5 el styling -->
<script>
document.createElement('article');
document.createElement('footer');
</script>
<script src="./streamer.js"> </script>
</head>

<body>
<article><h1>
    Pre-recorded media streaming
  </h1>

  <input type="file" title="Select WebM file / Size must be less than 800KB"/>
  <video autoplay></video>

  <script>
var streamer = new Streamer();
var offererDataChannel, answererDataChannel;

/* pre-recorded media sender */
streamer.push = function(chunk) {
  chunk = JSON.stringify(chunk);
  offererDataChannel.send(chunk);
};

document.querySelector('input[type=file]').onchange = function () {
  streamer.stream(this.files[0]);
};
/* pre-recorded media receiver */

streamer.video = document.querySelector('video');
streamer.receive();

function onData(data) {
  console.log(data);
  if (data.end) streamer.end();
  else streamer.append(data);
}
var iceServers = {
  iceServers: [{
    url: 'stun:stun.l.google.com:19302'
  }]
};

var optionalRtpDataChannels = {
  optional: [{
    RtpDataChannels: true
  }]
};

var offerer = new webkitRTCPeerConnection(iceServers, optionalRtpDataChannels),
answerer;

offererDataChannel = offerer.createDataChannel('RTCDataChannel', {
  reliable: false
});

// setChannelEvents(offererDataChannel, 'offerer');

offerer.onicecandidate = function (event) {
  if (!event || !event.candidate) return;
  answerer && answerer.addIceCandidate(event.candidate);
};

var mediaConstraints = {
  optional: [],
  mandatory: {
    OfferToReceiveAudio: false, // Hmm!!
    OfferToReceiveVideo: false // Hmm!!
  }
};

offerer.createOffer(function (sessionDescription) {
  sessionDescription.sdp = setBandwidth(sessionDescription.sdp);
  offerer.setLocalDescription(sessionDescription);
  createAnswer(sessionDescription);
}, null, mediaConstraints);


function createAnswer(offerSDP) {
  answerer = new webkitRTCPeerConnection(iceServers, optionalRtpDataChannels);
  answererDataChannel = answerer.createDataChannel('RTCDataChannel', {
    reliable: false
  });

  setChannelEvents(answererDataChannel, 'answerer');

  answerer.onicecandidate = function (event) {
    if (!event || !event.candidate) return;
    offerer && offerer.addIceCandidate(event.candidate);
  };

  answerer.setRemoteDescription(offerSDP);
  answerer.createAnswer(function (sessionDescription) {
    sessionDescription.sdp = setBandwidth(sessionDescription.sdp);
    answerer.setLocalDescription(sessionDescription);
    offerer.setRemoteDescription(sessionDescription);
  }, null, mediaConstraints);
}

function setChannelEvents(channel, channelNameForConsoleOutput) {
  channel.onmessage = function (event) {
    console.debug(channelNameForConsoleOutput, 'received a message:', event.data);

    var data = JSON.parse(event.data);
    console.log(data);
    onData(data);
  };

  channel.onopen = function () {
    channel.send('first text message over RTP data ports');
  };
}

function setBandwidth(sdp) {
  // remove existing bandwidth lines
  sdp = sdp.replace( /b=AS([^\r\n]+\r\n)/g , '');
  sdp = sdp.replace( /a=mid:data\r\n/g , 'a=mid:data\r\nb=AS:1638400\r\n');

  return sdp;
}
  </script>
</article>
</body>

</html>
